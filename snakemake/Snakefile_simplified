from pathlib import Path
import json
import yaml



with open("configs/config_snakemake.yaml", "r", encoding="utf-8") as f:
    config_snakemake = yaml.load(f, Loader=yaml.FullLoader)


#define parameters , keep them in list as it iterates, multiple input can be included. 
regions = config_snakemake["study_region_name"]
technologies = config_snakemake["technologies"]
scenario= config_snakemake["scenario"]


def logpath(region, filename):
    return Path("data") / region / "snakemake_log" / filename

# Create directories for each region and snakemake log
for r in regions:
    Path(f"data/{r}/snakemake_log").mkdir(parents=True, exist_ok=True)

"""script to run in terminal
The snakemake workflow will parallelize (--cores > 1) everything else but the spatial_data_prep script. 
The resources are limited to openeo cause the api is throwing problems with parallelization. 
    use thi line ---->  snakemake --cores 4 --resources openeo_req=1
to use a specific Snakefile, use the --snakefile option
    use this line ----> snakemake --snakefile snakemake/Snakefile_short_short --cores 4 --resources openeo_req=1
"""

rule all:
    input:
        expand(logpath("{region}", "spatial_data_prep.done"), region=regions),
        expand(logpath("{region}", "exclusion_{technology}_{scenario}.done"), region=regions, technology=technologies, scenario=scenario),

rule spatial_data_prep:
    output:
        touch(logpath("{region}", "spatial_data_prep.done"))
    resources:
        openeo_req=1
    params:
        method="snakemake"
    shell:
        "python spatial_data_prep.py --region {wildcards.region} --method {params.method}"

rule exclusion:
    input:
        logpath("{region}", "spatial_data_prep.done")
    output:
        touch(logpath("{region}", "exclusion_{technology}_{scenario}.done"))
    params:
        method="snakemake",
        scenario=scenario 
    shell:
        (
            "python Exclusion.py --region {wildcards.region} "
            "--technology {wildcards.technology} --method {params.method} --scenario {params.scenario}"
        )
